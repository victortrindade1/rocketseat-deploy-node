# Configurando NGINX

O Nginx é uma ferramenta de proxy reversor. Ele me ajuda a configurar as portas.
Por enquanto o app abre na porta 3333, mas quero q ele abra na porta 80, q é a
porta padrão, onde entra só de botar a URL.

O Nginx se torna necessário qnd existe mais de um app no servidor, ou qnd um
app possui subdomínios. Ele q redireciona para a porta. O Node sozinho não
gerencia portas.

No server:

deploy@deploy-bootcamp:~$ `sudo apt install nginx`

Habilite a porta 80 no server (no meu caso não foi necessário):

deploy@deploy-bootcamp:~$ `sudo ufw allow 80`

Se tudo deu certo, vc pode acessar o server pelo IP dele no browser. Vai
aparecer uma tela do Nginx.

## Redirecionando da porta 80 pra 3333

O q vou fazer no Nginx é redirecionar da porta 80 (a porta default do URL) pra
3333 no server. Eu poderia simplesmente colocar meu server direto pra porta 80.
Funcionaria. Porém, eu não conseguiria colocar aqui outros apps.

Edite o site padrão q vem no Nginx:

deploy@deploy-bootcamp:~$ `sudo nano /etc/nginx/sites-available/default`

```diff
-##
-# You should look at the following URL's in order to grasp a solid understanding
-# of Nginx configuration files in order to fully unleash the power of Nginx.
-# https://www.nginx.com/resources/wiki/start/
-# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
-# https://wiki.debian.org/Nginx/DirectoryStructure
-#
-# In most cases, administrators will remove this file from sites-enabled/ and
-# leave it as reference inside of sites-available where it will continue to be
-# updated by the nginx packaging team.
-#
-# This file will automatically load configuration files provided by other
-# applications, such as Drupal or Wordpress. These applications will be made
-# available underneath a path with that package name, such as /drupal8.
-#
-# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
-##
-
-# Default server configuration
-#
server {
        listen 80 default_server;
        listen [::]:80 default_server;

-        # SSL configuration
-        #
-        # listen 443 ssl default_server;
-        # listen [::]:443 ssl default_server;
-        #
-        # Note: You should disable gzip for SSL traffic.
-        # See: https://bugs.debian.org/773332
-        #
-        # Read up on ssl_ciphers to ensure a secure configuration.
-        # See: https://bugs.debian.org/765782
-        #
-        # Self signed certs generated by the ssl-cert package
-        # Don't use them in a production server!
-        #
-        # include snippets/snakeoil.conf;
-
-        root /var/www/html;
-
-        # Add index.php to the list if you are using PHP
-        index index.html index.htm index.nginx-debian.html;

        server_name _;

        location / {
-                # First attempt to serve request as file, then
-                # as directory, then fall back to displaying a 404.
-                try_files $uri $uri/ =404;
+                proxy_pass http://localhost:3333;
+                proxy_http_version 1.1;
+                proxy_set_header Upgrade $http_upgrade;
+                proxy_set_header Connection 'upgrade';
+                proxy_set_header Host $host;
+                proxy_cache_bypass $http_upgrade;
        }

-        # pass PHP scripts to FastCGI server
-        #
-        #location ~ \.php$ {
-        #       include snippets/fastcgi-php.conf;
-        #
-        #       # With php-fpm (or other unix sockets):
-        #       fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
-        #       # With php-cgi (or other tcp sockets):
-        #       fastcgi_pass 127.0.0.1:9000;
-        #}
-
-        # deny access to .htaccess files, if Apache's document root
-        # concurs with nginx's one
-        #
-        #location ~ /\.ht {
-        #       deny all;
-        #}
}


-# Virtual Host configuration for example.com
-#
-# You can move that to a different file under sites-available/ and symlink that
-# to sites-enabled/ to enable it.
-#
-#server {
-#       listen 80;
-#       listen [::]:80;
-#
-#       server_name example.com;
-#
-#       root /var/www/example.com;
-#       index index.html;
-#
-#       location / {
-#               try_files $uri $uri/ =404;
-#       }
-#}
```

Existem outras configurações q dá pra fazer no Nginx, em relação a performance
e segurança.

Reinicie o Nginx:

deploy@deploy-bootcamp:~$ `sudo service nginx restart`

Para testar, rode o servidor `npm run start`, vá no Insomnia, tire a porta 3333
do base_url, deixe apenas o domínio, e teste uma request.

O domínio com uma URL no lugar do IP é algo configurado no painel da Digital
Ocean. Não é necessário configurar domínio de URL no Nginx.
